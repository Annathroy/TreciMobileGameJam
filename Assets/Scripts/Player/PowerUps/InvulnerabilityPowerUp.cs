using UnityEngine;

[DisallowMultipleComponent]
public class InvulnerabilityPowerUp : PowerUp
{
    private PlayerHealth health;

    [Header("Bubble Visual Effect")]
    [SerializeField] private Sprite bubbleSprite;
    [Tooltip("If bubbleSprite is null, loads from Resources/<this path>. Example: Resources/Sprites/Bubble.png")]
    [SerializeField] private string defaultBubbleSpritePath = "Sprites/Bubble";

    [SerializeField] private Vector2 bubbleSize = new Vector2(5f, 5f);
    [SerializeField] private Vector3 bubbleOffset = Vector3.zero;
    [SerializeField] private Color bubbleTint = Color.white;
    [Range(0f, 1f)][SerializeField] private float bubbleTransparency = 1.0f;

    [Header("Pulse Animation")]
    [SerializeField] private bool enablePulseAnimation = true;
    [SerializeField] private float pulseSpeed = 3f;
    [SerializeField] private float pulseIntensity = 0.15f;

    [Header("Material (URP)")]
    [Tooltip("Optional. If left empty, a URP 2D Sprite shader material will be created in code.")]
    [SerializeField] private Material bubbleMaterialOverride;
    [Tooltip("Tried in order if no material is provided.")]
    [SerializeField]
    private string[] urpSpriteShaderFallbacks = new[]
    {
        "Universal Render Pipeline/2D/Sprite-Unlit-Default",
        "Universal Render Pipeline/2D/Sprite-Lit-Default"
    };

    private GameObject bubbleVisual;
    private SpriteRenderer bubbleRenderer;
    private Vector3 baseBubbleScale;
    private Material runtimeMaterial; // created if no override is provided

    protected override void OnActivate()
    {
        EnsureRefs();
        if (!health) return;

        health.GrantInvulnerability(duration);
        CreateBubbleVisual();
    }

    protected override void OnStack(int newCount)
    {
        EnsureRefs();
        if (!health) return;

        health.GrantInvulnerability(duration);
        if (!bubbleVisual) CreateBubbleVisual();
    }

    protected override void OnUnstack(int newCount)
    {
        // no-op; PlayerHealth ends invuln on its own timer
    }

    protected override void OnDeactivate()
    {
        DestroyBubbleVisual();
    }

    private void CreateBubbleVisual()
    {
        if (!player || bubbleVisual != null) return;

        // Ensure sprite
        if (bubbleSprite == null)
        {
            bubbleSprite = Resources.Load<Sprite>(defaultBubbleSpritePath);
            if (bubbleSprite == null)
            {
                Debug.LogWarning($"[InvulnerabilityPowerUp] No bubble sprite assigned and none found at Resources/{defaultBubbleSpritePath}.");
                return;
            }
        }

        // Root object
        bubbleVisual = new GameObject("InvulnerabilityBubble");
        bubbleVisual.transform.SetParent(player.transform, false);
        bubbleVisual.transform.localPosition = bubbleOffset;
        // Face upward for a top-down camera (XY sprite plane aligned with world XZ)
        bubbleVisual.transform.localRotation = Quaternion.Euler(90f, 0f, 0f);
        bubbleVisual.transform.localScale = new Vector3(bubbleSize.x, bubbleSize.y, 1f);
        baseBubbleScale = bubbleVisual.transform.localScale;

        // Renderer
        bubbleRenderer = bubbleVisual.AddComponent<SpriteRenderer>();
        bubbleRenderer.sprite = bubbleSprite;
        bubbleRenderer.sortingOrder = 10;

        // Color + alpha
        var c = bubbleTint; c.a = bubbleTransparency;
        bubbleRenderer.color = c;

        // Material handling (fixes pink)
        if (bubbleMaterialOverride != null)
        {
            bubbleRenderer.material = bubbleMaterialOverride;
        }
        else
        {
            Shader found = null;
            foreach (var name in urpSpriteShaderFallbacks)
            {
                found = Shader.Find(name);
                if (found != null) break;
            }

            if (found != null)
            {
                runtimeMaterial = new Material(found);
                bubbleRenderer.material = runtimeMaterial;
            }
            else
            {
                Debug.LogWarning("[InvulnerabilityPowerUp] URP 2D Sprite shader not found. Ensure URP 2D Renderer is installed and active.");
            }
        }
    }

    private void DestroyBubbleVisual()
    {
        if (bubbleVisual != null)
        {
            Destroy(bubbleVisual);
            bubbleVisual = null;
        }

        bubbleRenderer = null;

        // Clean up runtime material if we created one
        if (runtimeMaterial != null)
        {
            Destroy(runtimeMaterial);
            runtimeMaterial = null;
        }
    }

    private void Update()
    {
        if (enablePulseAnimation && bubbleVisual != null)
        {
            float pulse = 1f + Mathf.Sin(Time.time * pulseSpeed) * pulseIntensity;
            bubbleVisual.transform.localScale = baseBubbleScale * pulse;
        }
    }

    private void OnDestroy()
    {
        DestroyBubbleVisual();
    }

    private void EnsureRefs()
    {
        if (health) return;
        if (!player) return;
        health = player.GetComponent<PlayerHealth>() ?? player.GetComponentInChildren<PlayerHealth>(true);
        if (!health) Debug.LogError("[InvulnerabilityPowerUp] PlayerHealth not found on player.");
    }
}
