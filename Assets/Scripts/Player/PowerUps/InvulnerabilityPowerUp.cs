using UnityEngine;

public class InvulnerabilityPowerUp : PowerUp
{
    private PlayerHealth health;

    [Header("Bubble Visual Effect")]
    [SerializeField] private Sprite bubbleSprite;
    [SerializeField] private Vector2 bubbleSize = new Vector2(2f, 2f);
    [SerializeField] private Vector3 bubbleOffset = new Vector3(0f, 0f, 0f);
    [SerializeField] private Color bubbleTint = Color.white;
    [SerializeField] private float bubbleTransparency = 1.0f;
    [SerializeField] private bool enablePulseAnimation = true;
    [SerializeField] private float pulseSpeed = 3f;
    [SerializeField] private float pulseIntensity = 0.15f;

    private GameObject bubbleVisual;
    private SpriteRenderer bubbleRenderer;
    private Vector3 baseBubbleScale;

    protected override void OnActivate()
    {
        EnsureRefs();
        if (!health) return;

        // start (or restart) short-term invulnerability for `duration` seconds
        health.GrantInvulnerability(duration);

        // Create bubble visual
        CreateBubbleVisual();
    }

    protected override void OnStack(int newCount)
    {
        // We use refresh-on-pickup behavior, but if stacking is enabled,
        // just refresh the invulnerability again (no additive effect needed).
        if (!health) EnsureRefs();
        if (!health) return;
        health.GrantInvulnerability(duration);

        // If bubble was destroyed for some reason, recreate it
        if (!bubbleVisual)
        {
            CreateBubbleVisual();
        }
    }

    protected override void OnUnstack(int newCount)
    {
        // No-op: PlayerHealth stops invulnerability itself at the end of its timer.
    }

    protected override void OnDeactivate()
    {
        // Remove bubble visual when power-up expires
        DestroyBubbleVisual();
    }

    private void CreateBubbleVisual()
    {
        if (!player || bubbleVisual != null) return;

        // Create a GameObject with SpriteRenderer instead of a Quad
        bubbleVisual = new GameObject("InvulnerabilityBubble");
        bubbleVisual.transform.SetParent(player.transform, false);

        // Position directly on top of the player and rotate for top-down view
        bubbleVisual.transform.localPosition = bubbleOffset;
        bubbleVisual.transform.localRotation = Quaternion.Euler(90f, 0f, 0f); // Rotate to face upward for top-down camera
        bubbleVisual.transform.localScale = new Vector3(bubbleSize.x, bubbleSize.y, 1f);
        baseBubbleScale = bubbleVisual.transform.localScale;

        // Add SpriteRenderer component
        bubbleRenderer = bubbleVisual.AddComponent<SpriteRenderer>();

        // Apply the sprite
        if (bubbleSprite != null)
        {
            bubbleRenderer.sprite = bubbleSprite;
        }
        else
        {
            Debug.LogWarning("[InvulnerabilityPowerUp] No bubble sprite assigned! Assign a sprite in the inspector.");
        }

        // Apply color with transparency
        Color finalColor = bubbleTint;
        finalColor.a = bubbleTransparency;
        bubbleRenderer.color = finalColor;

        // Configure sprite renderer settings
        bubbleRenderer.sortingOrder = 10; // Render on top of other sprites
        bubbleRenderer.material = null; // Use default sprite material
    }

    private void DestroyBubbleVisual()
    {
        if (bubbleVisual != null)
        {
            Destroy(bubbleVisual);
            bubbleVisual = null;
        }

        bubbleRenderer = null;
    }

    private void Update()
    {
        // Handle pulse animation
        if (enablePulseAnimation && bubbleVisual != null)
        {
            float pulse = 1f + Mathf.Sin(Time.time * pulseSpeed) * pulseIntensity;
            bubbleVisual.transform.localScale = baseBubbleScale * pulse;
        }
    }

    private void OnDestroy()
    {
        // Clean up bubble visual when the component is destroyed
        DestroyBubbleVisual();
    }

    private void EnsureRefs()
    {
        if (health) return;
        if (!player) return;
        health = player.GetComponent<PlayerHealth>() ?? player.GetComponentInChildren<PlayerHealth>(true);
        if (!health) Debug.LogError("[InvulnerabilityPowerUp] PlayerHealth not found on player.");
    }
}