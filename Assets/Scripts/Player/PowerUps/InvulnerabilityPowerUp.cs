using UnityEngine;

[DisallowMultipleComponent]
public class InvulnerabilityPowerUp : PowerUp
{
    private PlayerHealth health;

    [Header("Bubble Visual Effect")]
    [SerializeField] private Sprite bubbleSprite;
    [SerializeField] private string defaultBubbleSpritePath = "Sprites/Bubble"; // Resources/Sprites/Bubble.png
    [SerializeField] private Vector2 bubbleSize = new Vector2(2f, 2f);
    [SerializeField] private Vector3 bubbleOffset = new Vector3(0f, 0f, 0f);
    [SerializeField] private Color bubbleTint = Color.white;
    [SerializeField] private float bubbleTransparency = 1.0f;
    [SerializeField] private bool enablePulseAnimation = true;
    [SerializeField] private float pulseSpeed = 3f;
    [SerializeField] private float pulseIntensity = 0.15f;

    private GameObject bubbleVisual;
    private SpriteRenderer bubbleRenderer;
    private Vector3 baseBubbleScale;

    protected override void OnActivate()
    {
        EnsureRefs();
        if (!health) return;

        health.GrantInvulnerability(duration);
        CreateBubbleVisual();
    }

    protected override void OnStack(int newCount)
    {
        EnsureRefs();
        if (!health) return;

        health.GrantInvulnerability(duration);
        if (!bubbleVisual)
            CreateBubbleVisual();
    }

    protected override void OnUnstack(int newCount)
    {
        // no-op, invuln handled by PlayerHealth
    }

    protected override void OnDeactivate()
    {
        DestroyBubbleVisual();
    }

    private void CreateBubbleVisual()
    {
        if (!player || bubbleVisual != null) return;

        // Ensure a sprite exists before creating
        if (bubbleSprite == null)
        {
            bubbleSprite = Resources.Load<Sprite>(defaultBubbleSpritePath);
            if (bubbleSprite == null)
            {
                Debug.LogWarning($"[InvulnerabilityPowerUp] No bubble sprite assigned or found at Resources/{defaultBubbleSpritePath}. Assign one in code or inspector.");
                return;
            }
        }

        bubbleVisual = new GameObject("InvulnerabilityBubble");
        bubbleVisual.transform.SetParent(player.transform, false);
        bubbleVisual.transform.localPosition = bubbleOffset;
        bubbleVisual.transform.localRotation = Quaternion.Euler(90f, 0f, 0f);
        bubbleVisual.transform.localScale = new Vector3(bubbleSize.x, bubbleSize.y, 1f);
        baseBubbleScale = bubbleVisual.transform.localScale;

        bubbleRenderer = bubbleVisual.AddComponent<SpriteRenderer>();
        bubbleRenderer.sprite = bubbleSprite;

        Color finalColor = bubbleTint;
        finalColor.a = bubbleTransparency;
        bubbleRenderer.color = finalColor;
        bubbleRenderer.sortingOrder = 10;
        bubbleRenderer.material = null;
    }

    private void DestroyBubbleVisual()
    {
        if (bubbleVisual != null)
        {
            Destroy(bubbleVisual);
            bubbleVisual = null;
        }
        bubbleRenderer = null;
    }

    private void Update()
    {
        if (enablePulseAnimation && bubbleVisual != null)
        {
            float pulse = 1f + Mathf.Sin(Time.time * pulseSpeed) * pulseIntensity;
            bubbleVisual.transform.localScale = baseBubbleScale * pulse;
        }
    }

    private void OnDestroy()
    {
        DestroyBubbleVisual();
    }

    private void EnsureRefs()
    {
        if (health) return;
        if (!player) return;

        health = player.GetComponent<PlayerHealth>() ?? player.GetComponentInChildren<PlayerHealth>(true);
        if (!health)
            Debug.LogError("[InvulnerabilityPowerUp] PlayerHealth not found on player.");
    }
}
